{%load static%} <link rel="stylesheet" href="{% static 'css/form.css' %}" />
<link rel="stylesheet" href="{% static 'css/sweetalert2.css' %}" />

<div class="container">
  {% if student.pk %}
  <h2 style="text-align: center">编辑学生信息</h2>
  {% else %}
  <h2 style="text-align: center">添加学生信息</h2>
  {% endif %}
  <form method="post">
    {% csrf_token %} {% for field in form %}
    <div class="form-group">
      <label for="{{field.id_for_label}}"> {{field.label}}:</label>
      {{field}} {% comment %} {% if field.help_text %}
      <small class="from-text text-muted">{{field.help_text}}</small>
      {% endif %} {% endcomment %}

      <ul class="errors">
        {% for error in field.errors %}
        <li>{{error}}</li>
        {% endfor %}
      </ul>
    </div>
    {% endfor %}
    <div class="handleButton">
      <button type="submit" id="saveButton">保存</button>
      <!-- 调用父模板中sweetalert2的JS -->
      <button type="submit" id="cancelButton" onlick="window.parent.Swal.close()">删除</button>
    </div>
  </form>
</div>
<script src="{% static 'js/sweetalert2.js' %}"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.querySelector("form");
    const url = "{% url 'student_create' %}";
    form.addEventListener("submit", function (e) {
      e.preventDefault();
      let formData = new FormData(form);
      fetch(url, {
        method: "POST",
        body: formData,
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          "X-CSRFToken": formData.get("csrfmiddlewaretoken"),
        },
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.status === "success") {
            Swal.fire({
              icon: "success",
              title: data.messages,
              text: "数据已提交",
            }).then((result) => {
              if (result.isConfirmed) {
                window.parent.location.reload(); // 刷新父页面
              }
            });
          } else {
            // 解析JSON
            const errors = JSON.parse(data.messages);
            // 构造错误信息的文本
            let errorMessage = "";

            for (const field in errors) {
              // 遍历errors内每个字段(field)对应的错误信息
              if (errors.hasOwnProperty(field)) {
                // 如果该字段有对应的错误信息
                errors[field].forEach((error) => {
                  errorMessage += `<li style="color:red;text-align:left;margin-left:100px;">${error.message}</li>`;
                });
              }
            }
            Swal.fire({
              icon: "error",
              title: "提交错误",
              html: errorMessage,
              confirmButtonText: "关闭",
            });
          }
        })
        .catch((error) => {
          Swal.fire({
            icon: "error",
            title: "网络请求失败",
            text: "无法连接到服务器. 请稍候再试.",
            confirmButtonText: "关闭",
          });
        });
    });
  });
</script>
