{%extends 'base.html'%} {%block content%}

<div class="right">
<div class="top">
<div class="tool">
<div class="class-info">
<form action="/students/">
<span>班级: </span>
<select name="grade">
<option value="" selected>请选择班级</option>

<option value="8">
1年1班
</option>
<option value="6">
1年2班
</option>
<option value="7">
1年3班
</option>
<option value="9">
1年4班
</option>
<option value="10">
1年5班
</option>
</select>
<span>姓名/学号:</span>
<input type="text" name="search" value>
<input type="submit" value="搜索">
</form>
</div>
<div class="actions">
<button type="button" class="add" id="add">新增</button>
<button type="button" class="del" id="del-all">批量删除</button>
<button type="button" class="import" id="import">导入</button>
<button type="button" class="export" id="export">导出</button>
</div>
</div>
</div>
<div class="bottom">
<table>
<thead>
<tr>
<th><input type="checkbox" id="select-all"></th>
<th>姓名</th>
<th>班级</th>
<th>学号</th>
<th>性别</th>
<th>生日</th>
<th>联系电话</th>

<th>操作</th>
</tr>
</thead>
  <tbody>
    {% for student in students %}
    <tr>
      <td><input type="checkbox" name="student_ids" value="{{student.pk}}"></td>
      <td>{{student.student_name}}</td>
      <td>{{student.grade.grade_name}}</td>
      <td>{{student.student_number}}</td>
      <td>{{student.gender}}</td>
      <td>{{student.birthday}}</td>
      <td>{{student.contact_number}}</td>
      <td>
        <a href="{% url 'student_update' student.pk %}" class="btn btn-primary btn-sm edit">编辑</a>
        <a href="{% url 'student_delete' student.pk %}" class="btn btn-danger btn-sm del">删除</a>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<div class="pagination">
<span class="step-links">
<span class="step-links">

<span class="current">
1 / 2
</span>

<a href="http://127.0.0.1:8000/students/?page=2">下一页</a>
<a href="http://127.0.0.1:8000/students/?page=2">尾页 »</a>

</span>
</span>
</div>
</div>
</div>
</div>

<script>
  // 选中所有学生:
  document.getElementById("select-all").addEventListener("change",function(){
    const checkboxes = document.querySelectorAll("input[name='student_ids']");
    checkboxes.forEach( checkbox =>{
      checkbox.checked = this.checked;
    })
  })

  
  // 给新增按钮添加弹窗效果:
  // 处理新增按钮点击事件:
  document.getElementById("add").addEventListener("click", function () {
    Swal.fire({
      position: "top-end",
      html: `<iframe src='{%url 'student_create'%}' width=100% height='800px' frameborder='0'></iframe>`,
      width: 600,
      // 取消iframe里的确认按钮
      showConfirmButton: false,
    });
  });
  // 处理编辑按钮点击时间:
  document.querySelectorAll(".edit").forEach( button =>{
    button.addEventListener("click", function(e){
      e.preventDefault();
      const url = this.getAttribute("href");
      Swal.fire({
        position: "top-end",
        html: `<iframe src='${url}' width=100% height='800px' frameborder='0'></iframe>`,
        width: 600,
        // 取消iframe里的确认按钮
        showConfirmButton: false,
      });
    })
  })

  // 处理删除按钮点击事件:
  document.querySelectorAll(".btn-danger").forEach( button =>{
    button.addEventListener("click", function(e){
      e.preventDefault();
      const url = this.getAttribute("href");
      Swal.fire({
        title:'确认删除吗?',
        icon:'warning',
        showCancelButton:true,
        confirmButtonText:'确认',
        confirmButtonColor:'#d33',
      }).then((result)=>{
        if(result.isConfirmed){
          fetch(url,{
            method:'DELETE',
            headers:{
              'X-Requested-With':'XMLHttpRequest',
              'X-CSRFToken':'{{csrf_token}}'
            },
          }).then(response => response.json())
          .then(data => {
            if (data.status === 'success'){
              Swal.fire("Deleted!", data.messages, "success")
              window.location.reload(); 
            } else {
              Swal.fire("Error!", data.messages, "error")
            }
          })
        }
      })
    })
  })
  

  // 处理批量删除按钮点击事件:
  document.getElementById("del-all").addEventListener("click", function(){
    // 获取所有被选中的学生:
    const checkboxes = document.querySelectorAll('input[name="student_ids"]:checked');
    // 如果没有选中任何学生, 则弹出提示:
    if (checkboxes.length === 0){
      Swal.fire("Error!", "请至少选择一个学生", "error")
      return;
    }

    // 弹出确认删除的对话框:
    Swal.fire({
      title:'确认删除吗?',
      icon:'warning',
      showCancelButton:true,
      confirmButtonText:'确认',
      confirmButtonColor:'#d33',
    }).then((result)=>{
      if(result.isConfirmed){
        // 获取所有被选中的学生的ID:
        const formData = new FormData();
        checkboxes.forEach((checkbox) =>{
          formData.append('student_ids', checkbox.value);
        })
        fetch("{% url 'student_bulk_delete' %}",
          {
            method:'POST',
            headers: {
              'X-Requested-With':'XMLHttpRequest',
              'X-CSRFToken':'{{csrf_token}}',
            },
            body: formData,
          }
        ).then(response => response.json()).then(data =>{
          if (data.status === 'success'){
              Swal.fire("Deleted!", data.messages, "success")
              window.location.reload(); 
            } else {
              Swal.fire("Error!", data.messages, "error")
            }
        })
      }
    })
  })
</script>
{% endblock %}
