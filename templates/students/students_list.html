{%extends 'base.html'%}
{% load url_utils %}
{%block content%}

<div class="right">
<div class="top">
<div class="tool">
<div class="class-info">
<form action="/students/">
<span>班级: </span>
<select name="grade">
  <option value="" selected>请选择班级</option>
  {% for grade in grades %}
    <option value="{{grade.pk}}" {% if grade.pk|stringformat:"s" == current_grade %} selected {% endif %}>
      {{grade.grade_name}}
    </option>
  {% endfor %}
</select>
<span>姓名/学号:</span>
<input type="text" name="search" value>
<input type="submit" value="搜索">
</form>
</div>
<div class="actions">
<button type="button" class="add" id="add">新增</button>
<button type="button" class="del" id="del-all">批量删除</button>
<button type="button" class="import" id="import">导入</button>
<button type="button" class="export" id="export">导出</button>
</div>
</div>
</div>
<div class="bottom">
<table>
<thead>
<tr>
<th><input type="checkbox" id="select-all"></th>
<th>姓名</th>
<th>班级</th>
<th>学号</th>
<th>性别</th>
<th>生日</th>
<th>联系电话</th>

<th>操作</th>
</tr>
</thead>
  <tbody>
    {% for student in students %}
    <tr>
      <td><input type="checkbox" name="student_ids" value="{{student.pk}}"></td>
      <td>{{student.student_name}}</td>
      <td>{{student.grade.grade_name}}</td>
      <td>{{student.student_number}}</td>
      <td>{{student.gender}}</td>
      <td>{{student.birthday}}</td>
      <td>{{student.contact_number}}</td>
      <td>
        <a href="{% url 'student_update' student.pk %}" class="btn btn-primary btn-sm edit">编辑</a>
        <a href="{% url 'student_delete' student.pk %}" class="btn btn-danger btn-sm del">删除</a>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<div class="pagination">
  <span class="step-links">
    <span class="step-links">
      {% if page_obj.has_previous %}
        <a href="?{% search_url request page=1 %}">&laquo; 首页</a>
        <a href="?{% search_url request page=page_obj.previous_page_number %}">上一页 »</a>
      {% endif %}
      <span class="current">
        第 {{ page_obj.number }} 页, 共 {{ page_obj.paginator.num_pages }} 页.
      </span>
      {% if page_obj.has_next %}
        <a href="?{% search_url request page=page_obj.next_page_number %}">下一页 »</a>
        <a href="?{% search_url request page=page_obj.paginator.num_pages %}">尾页 &raquo;</a>
      {% endif %}
    </span>
  </span>
</div>
</div>
</div>
</div>

<script>
  // 选中所有学生:
  document.getElementById("select-all").addEventListener("change",function(){
    const checkboxes = document.querySelectorAll("input[name='student_ids']");
    checkboxes.forEach( checkbox =>{
      checkbox.checked = this.checked;
    })
  })

  
  // 给新增按钮添加弹窗效果:
  // 处理新增按钮点击事件:
  document.getElementById("add").addEventListener("click", function () {
    Swal.fire({
      position: "top-end",
      html: `<iframe src='{%url 'student_create'%}' width=100% height='800px' frameborder='0'></iframe>`,
      width: 600,
      // 取消iframe里的确认按钮
      showConfirmButton: false,
    });
  });
  // 处理编辑按钮点击时间:
  document.querySelectorAll(".edit").forEach( button =>{
    button.addEventListener("click", function(e){
      e.preventDefault();
      const url = this.getAttribute("href");
      Swal.fire({
        position: "top-end",
        html: `<iframe src='${url}' width=100% height='800px' frameborder='0'></iframe>`,
        width: 600,
        // 取消iframe里的确认按钮
        showConfirmButton: false,
      });
    })
  })

  // 处理删除按钮点击事件:
  document.querySelectorAll(".btn-danger").forEach( button =>{
    button.addEventListener("click", function(e){
      e.preventDefault();
      const url = this.getAttribute("href");
      Swal.fire({
        title:'确认删除吗?',
        icon:'warning',
        showCancelButton:true,
        confirmButtonText:'确认',
        confirmButtonColor:'#d33',
      }).then((result)=>{
        if(result.isConfirmed){
          fetch(url,{
            method:'DELETE',
            headers:{
              'X-Requested-With':'XMLHttpRequest',
              'X-CSRFToken':'{{csrf_token}}'
            },
          }).then(response => response.json())
          .then(data => {
            if (data.status === 'success'){
              Swal.fire("Deleted!", data.messages, "success")
              window.location.reload(); 
            } else {
              Swal.fire("Error!", data.messages, "error")
            }
          })
        }
      })
    })
  })
  

  // 处理批量删除按钮点击事件:
  document.getElementById("del-all").addEventListener("click", function(){
    // 获取所有被选中的学生:
    const checkboxes = document.querySelectorAll('input[name="student_ids"]:checked');
    // 如果没有选中任何学生, 则弹出提示:
    if (checkboxes.length === 0){
      Swal.fire("Error!", "请至少选择一个学生", "error")
      return;
    }

    // 弹出确认删除的对话框:
    Swal.fire({
      title:'确认删除吗?',
      icon:'warning',
      showCancelButton:true,
      confirmButtonText:'确认',
      confirmButtonColor:'#d33',
    }).then((result)=>{
      if(result.isConfirmed){
        // 获取所有被选中的学生的ID:
        const formData = new FormData();
        checkboxes.forEach((checkbox) =>{
          formData.append('student_ids', checkbox.value);
        })
        fetch("{% url 'student_bulk_delete' %}",
          {
            method:'POST',
            headers: {
              'X-Requested-With':'XMLHttpRequest',
              'X-CSRFToken':'{{csrf_token}}',
            },
            body: formData,
          }
        ).then(response => response.json()).then(data =>{
          if (data.status === 'success'){
              Swal.fire("Deleted!", data.messages, "success")
              window.location.reload(); 
            } else {
              Swal.fire("Error!", data.messages, "error")
            }
        })
      }
    })
  })
  document.getElementById('import').addEventListener('click', function(){
    Swal.fire({
      title:'upload student infor excel',
      input:'file',
      inputAttributes:{
        'accept':'.xlsx',
        'aria-lable':'Upload your Excel file',

      },
      showCancelButton:true,
      confirmButtonText:'Upload',
      showLoaderOnConfirm:true,
      preConfirm:(file) => {
        //处理文件上传的逻辑, 例如使用FormData 和 fetch API 上传文件
        const formData = new FormData();
        formData.append('excel_file',file);
        return fetch('{% url "upload_student"%}',{
          method:'POST',
          headers:{
            'X-CSRFToken':'{{ csrf_token }}',
          },
          body:formData,
        })
        .then(response => response.json())
        .then(data => {
          if(data.status ==='error'){
            throw new Error(data.messages);
          }
        })
        .catch(error => {
          console.log(error);
          Swal.showValidationMessage(`${error.messages || error}`);
        })
      },
      allowOutsideClick: () => !Swal.isLoading()
    }).then((result) => {
      if(result.isConfirmed){
        Swal.fire({
          title:"Uploaded!",
          text:"上传成功",
        }).then(()=>{
          window.location.reload();
        });
      }
    })
    })

    //导出excel
    document.getElementById('export').addEventListener('click', function(){
      //检查是否选择啦班级
      let select = document.querySelector('select[name="grade"]');
      // 获取select的value
      let value = select.value
      // 获取选择的文本内容gradeText
      let gradeText = select.options[select.selectedIndex].text;
      console.log(gradeText);
      if (!value){
        Swal.fire({
          title: '错误',
          text:'请选择一个班级',
          icon:'error',
          confirmButtonText: '确定'
        });
        return ;
      }

      // 提交请求
      Swal.fire({
        title:'确认',
        text: '导出' + gradeText + '学生信息',
        icon:'warning',
        showCancelButton: true,
        confirmButtonText:"确认",
        cancelButtonText:'取消',
      }).then((result)=>{
        if(result.isConfirmed){
          fetch('{% url "export_excel" %}',{
            method: "POST",
            headers: {
              'Content_Type': 'application/json',
              'X-CSRFToken':'{{ csrf_token}}',
            },
            body: JSON.stringify({grade:value})
          }).then(response => {
            if(!response.ok){
              response.json().then(result => {
                Swal.fire({
                  title:'Error!',
                  text: '服务器错误' + result.messages,
                  icon:'error',
                  confirmButtonText:'关闭'
                });
              });
              throw new Error('Network response was not ok');
            }
            return response.blob();
          }).then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = gradeText + '_学生信息.xlsx';
            document.body.appendChild(a);
            a.click();

            // 释放URL对象
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
          }).catch(errot => {
            console.error('下载失败', error);
            Swal.fire({
              title:'Error!',
              text: '下载失败' + error,
              icon:'error',
              confirmButtonText:'关闭'
            });
          });
        }
      })
    })
</script>
{% endblock %}
